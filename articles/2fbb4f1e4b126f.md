---
title: "Next.jsのブログにAlgoliaで検索機能を導入する"
emoji: "✍️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ['Next', 'Algolia']
published: false
---

[自身のブログ](https://kenzoblog.vercel.app/)にAlgoliaを使って検索機能を実装したときのメモです。

## 前提

```shell
# versions
- Next: ^10.0.0
- algoliasearch: ^4.9.1
- react-instantsearch-dom: ^6.10.3
```

ブログの記事データは[Static Generation](https://nextjs.org/docs/basic-features/pages#static-generation-recommended)で管理されています。詳しいディレクトリ構造などは[ソースコード](https://github.com/kenzo-tanaka/nextJsBlog)を見てもらえればと思います。

## Algoliaダッシュボードでインデックスを登録

[Algolia](https://www.algolia.com/users/sign_in)に登録をして、インデックスの登録などを行っていきます。

Create indexでインデックスを作成します。僕は`kenzo_blog`みたいな感じでサイト単位で登録しています。
![](/images/algolia/img-1.png)

作成されたインデックスにレコードを登録していくのですが、やり方が3つあります。まずは手動で登録して動作確認をするのが良いと思います。APIを使った登録は後述します。

- JSONファイルをアップロード
- APIから登録
- 手動で登録

僕の場合検索結果をリンクとして表示させたいので、タイトル・スラグなどをAlgoliaに登録しています。
![](/images/algolia/img-2.png)

## 必要なパッケージをインストール

ここから実装側の対応になります。

```shell
npm install algoliasearch
npm install react-instantsearch-dom
npm install instantsearch.css
```

## 検索用コンポーネントの作成

Algoliaの検索フォームを表示させるコンポーネントです。このコンポーネントを各ページで表示させています。

```tsx:components/search.tsx
import React, { useState } from "react";
import algoliasearch from "algoliasearch/lite";
import Link from "next/link";
import {
  SearchBox,
  Hits,
  Highlight,
  InstantSearch,
} from "react-instantsearch-dom";

// Algoliaの管理画面から取得できる環境変数を設定
// APIキーは「Search-Only API Key」の方
const algoliaSettings = {
  searchClient: algoliasearch(
    `${process.env.ALGOLIA_APP_ID}`,
    `${process.env.ALGOLIA_API_KEY}`
  ),
  indexName: "kenzo_blog",
};

// ヒットした項目をリンクとして表示
// Highlightを入れておくと検索と一致したところにスタイルを当てられる
const Hit = ({ hit }: any) => {
  return (
    <Link href={`/posts/${hit.slug}`}>
      <a>
        <div className="p-7">
          <div className="hitName">
            <Highlight attribute="title" tagName="span" hit={hit} />
          </div>
        </div>
      </a>
    </Link>
  );
};

const SearchResult = () => {
  return <Hits hitComponent={Hit} />;
};

const Search: React.FC = () => {
  const [suggestDisplay, toggleDisplay] = useState("hidden");

  return (
    <>
      <InstantSearch
        searchClient={algoliaSettings.searchClient}
        indexName={algoliaSettings.indexName}
      >
        <div
          onFocus={() => toggleDisplay("block")}
          onBlur={() =>
            setTimeout(() => {
              toggleDisplay("hidden");
            }, 300)
          }
        >
          <SearchBox translations={{ placeholder: "記事を検索" }} />
        </div>
        <div className={`relative ${suggestDisplay}`}>
          <div className="bg-white search-result p-3 shadow-lg absolute w-full z-10 h-96 overflow-y-scroll">
            <SearchResult />
          </div>
        </div>
      </InstantSearch>
    </>
  );
};

export default Search;
```


## API経由でAlgoliaにレコードを登録する